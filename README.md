# dbt-lineage-viewer

Interactive DBT lineage explorer with search and filtering. Parses `manifest.json` and renders an interactive DAG with Cytoscape.js + ELK layout.

## Installation

```bash
pip install git+https://github.com/tanakasan3/dbt-lineage-viewer.git
```

Or for development:

```bash
git clone https://github.com/tanakasan3/dbt-lineage-viewer.git
cd dbt-lineage-viewer

# Option 1: Makefile (creates venv automatically)
make dev
source .venv/bin/activate

# Option 2: pipx (isolated install)
make install-pipx

# Option 3: Manual venv
python3 -m venv .venv && source .venv/bin/activate
pip install -e .
```

## Usage

### Quick Start

Point it at a DBT project directory (must have `target/manifest.json`):

```bash
# Generate manifest first (if not already present)
cd /path/to/dbt/project
dbt parse  # or dbt compile

# Launch viewer
dbt-lineage serve /path/to/dbt/project
```

### Options

```bash
dbt-lineage serve [OPTIONS] DBT_PROJECT_PATH

Options:
  -p, --port INTEGER      Port to run server on (default: 8142)
  -h, --host TEXT         Host to bind to (default: 127.0.0.1)
  --manifest PATH         Path to manifest.json (default: target/manifest.json)
  --open / --no-open      Auto-open browser (default: --open)
  --help                  Show this message and exit.
```

### Examples

```bash
# Serve with custom port
dbt-lineage serve ./my_dbt_project --port 3000

# Use specific manifest file
dbt-lineage serve . --manifest ./compiled/manifest.json

# Don't auto-open browser
dbt-lineage serve . --no-open
```

## Features

- **Search**: Filter nodes by name with real-time highlighting
- **Lineage Focus**: Click a node to highlight upstream/downstream dependencies
- **Depth Control**: Slider to limit lineage depth (1-hop, 2-hop, etc.)
- **Layer Coloring**: Sources (green), staging (blue), intermediate (yellow), outputs (red)
- **SQL Preview**: Click a node to view its SQL and metadata
- **ELK Layout**: Hierarchical left-to-right layout for clear lineage flow
- **Column Lineage**: Click columns to trace their upstream sources through SQL parsing

### Column-Level Lineage

When you select a model, you can:

1. **View columns**: If documented in manifest, columns are shown in the panel
2. **Analyze SQL**: Click "Analyze SQL for Columns" to parse the SQL and extract column definitions
3. **Trace upstream**: Click any column to see which upstream tables/columns it derives from

The column tracer uses [sqlglot](https://github.com/tobymao/sqlglot) to parse SQL and extract:
- Direct column references (`customer_id` → `stg_orders.customer_id`)
- Transformations (`SUM(amount)` → derived from `amount`)
- Multi-table joins (resolves table aliases)
- Upstream chain (traces through multiple models)

## How It Works

1. Reads `manifest.json` from your DBT project's `target/` directory
2. Extracts nodes (models, sources, seeds, snapshots) and their dependencies
3. Serves a web UI with an interactive DAG visualization
4. All processing happens locally - no data leaves your machine

## Installing DBT

This tool requires a `manifest.json` file generated by DBT. If you don't have DBT installed:

### Using pip

```bash
# Core DBT (pick your adapter)
pip install dbt-core dbt-bigquery    # BigQuery
pip install dbt-core dbt-postgres    # PostgreSQL
pip install dbt-core dbt-snowflake   # Snowflake
pip install dbt-core dbt-redshift    # Redshift
pip install dbt-core dbt-duckdb      # DuckDB (great for local dev)
```

### Using Homebrew (macOS)

```bash
brew install dbt-labs/dbt/dbt-core
brew install dbt-labs/dbt/dbt-postgres  # or your adapter
```

### Generate the manifest

```bash
cd /path/to/your/dbt/project

# Option 1: Just parse (fastest, no DB connection needed)
dbt parse

# Option 2: Compile (resolves Jinja, needs profiles.yml)
dbt compile

# Option 3: Full run (executes models, generates manifest as side effect)
dbt run
```

The manifest will be at `target/manifest.json`.

### No DBT? Use the mock parser

If you can't install DBT but have the SQL files, use the included mock parser:

```bash
python scripts/generate_mock_manifest.py /path/to/dbt/project
```

This parses `ref()` and `source()` calls from SQL files directly. Less accurate than the real manifest, but works offline.

## Requirements

- Python 3.10+
- A DBT project with compiled `manifest.json` (or use mock parser)

## License

MIT
